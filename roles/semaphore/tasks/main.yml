---
# 1. Install required packages
- name: Install dependencies (Ubuntu)
  apt:
    name:
      - wget
      - tar
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: yes

# 2. Ensure PostgreSQL service is running
- name: Ensure PostgreSQL is running
  service:
    name: postgresql
    state: started
    enabled: yes

# 3. Create PostgreSQL user (safe + idempotent)
- name: Check if PostgreSQL user exists
  command: >
    sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ pg_user }}';"
  register: user_exists

- name: Create PostgreSQL user if not exists
  command: >
    sudo -u postgres psql -c "CREATE ROLE {{ pg_user }} LOGIN PASSWORD '{{ pg_pass }}';"
  when: user_exists.stdout.strip() == ""

# 4. Create PostgreSQL database (safe + idempotent)
- name: Check if database exists
  command: >
    sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ pg_db }}';"
  register: db_exists

- name: Create PostgreSQL database if not exists
  command: >
    sudo -u postgres psql -c "CREATE DATABASE {{ pg_db }} OWNER {{ pg_user }};"
  when: db_exists.stdout.strip() == ""

# 5. Create semaphore system user
- name: Create semaphore system user
  user:
    name: semaphore
    system: yes
    create_home: no

# 6. Download semaphore
- name: Download semaphore
  get_url:
    url: "https://github.com/ansible-semaphore/semaphore/releases/download/v{{ semaphore_version }}/semaphore_{{ semaphore_version }}_linux_amd64.tar.gz"
    dest: /tmp/semaphore.tar.gz

# 7. Create semaphore installation directory
- name: Create semaphore install directory
  file:
    path: "{{ semaphore_install_dir }}"
    state: directory
    owner: semaphore
    group: semaphore
    mode: "0755"

# 8. Extract semaphore
- name: Extract semaphore
  unarchive:
    src: /tmp/semaphore.tar.gz
    dest: "{{ semaphore_install_dir }}"
    remote_src: yes

# 9. Create semaphore directories
- name: Create semaphore directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ semaphore_user }}"
    group: "{{ semaphore_group }}"
    mode: "0755"
  loop:
    - "{{ semaphore_config_dir }}"
    - "{{ semaphore_data_dir }}"
    - "/tmp/semaphore"

# 10. Create semaphore config
- name: Create semaphore config
  template:
    src: config.json.j2
    dest: "{{ semaphore_config_dir }}/config.json"
    owner: "{{ semaphore_user }}"
    group: "{{ semaphore_group }}"
    mode: "0644"

# 11. Install semaphore systemd service
- name: Add systemd service
  template:
    src: semaphore.service.j2
    dest: /etc/systemd/system/semaphore.service

# 12. Reload systemd
- name: Reload daemon
  systemd:
    daemon_reload: yes

# 13. Start semaphore service
- name: Start semaphore
  systemd:
    name: semaphore
    state: started
    enabled: yes
