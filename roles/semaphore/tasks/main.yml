---
- name: Validate supported OS family
  ansible.builtin.assert:
    that:
      - ansible_os_family in ['Debian', 'RedHat', 'Amazon']
    fail_msg: "Unsupported OS family {{ ansible_os_family }}. Supported: Debian, RedHat, Amazon."
    success_msg: "OS family {{ ansible_os_family }} is supported for Semaphore installation."

- name: Install dependencies on Debian/Ubuntu
  ansible.builtin.apt:
    name: "{{ semaphore_packages_common }}"
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: Install dependencies on RedHat/CentOS/Amazon
  ansible.builtin.yum:
    name: "{{ semaphore_packages_common }}"
    state: present
  when: ansible_os_family in ['RedHat', 'Amazon']

- name: Create semaphore system user
  ansible.builtin.user:
    name: "{{ semaphore_user }}"
    system: true
    create_home: false

- name: Create semaphore directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ semaphore_user }}"
    group: "{{ semaphore_group }}"
    mode: "0755"
  loop:
    - "{{ semaphore_install_dir }}"
    - "{{ semaphore_config_dir }}"
    - "{{ semaphore_data_dir }}"

- name: Extract semaphore release archive
  ansible.builtin.unarchive:
    src: "https://github.com/ansible-semaphore/semaphore/releases/download/v{{ semaphore_version }}/semaphore_{{ semaphore_version }}_linux_amd64.tar.gz"
    dest: "{{ semaphore_install_dir }}"
    remote_src: true
  register: semaphore_unarchive

- name: Render semaphore config.json
  ansible.builtin.template:
    src: config.json.j2
    dest: "{{ semaphore_config_dir }}/config.json"
    owner: "{{ semaphore_user }}"
    group: "{{ semaphore_group }}"
    mode: "0644"

- name: Install semaphore systemd service unit
  ansible.builtin.template:
    src: semaphore.service.j2
    dest: "{{ semaphore_service_unit_path }}"
  notify: Reload systemd

- name: Flush handlers before starting semaphore
  ansible.builtin.meta: flush_handlers

- name: Ensure semaphore service is enabled and running
  ansible.builtin.systemd:
    name: "{{ semaphore_service_name }}"
    state: started
    enabled: true
